!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(require("jquery"),require("filepicker")):"function"==typeof define&&define.amd?define(["jquery","filepicker"],factory):factory(global.jQuery,global.Filepicker)}(this,(function($,Filepicker){"use strict";$="default"in $?$.default:$,Filepicker="default"in Filepicker?Filepicker.default:Filepicker;var defaults={crop:{selectors:{crop:".crop",container:"#crop-modal",loading:".crop-loading",preview:".crop-preview",save:".crop-save",hide:".crop-hide",rotateLeft:".crop-rotate-left",rotateRight:".crop-rotate-right",flipHorizontal:".crop-flip-horizontal",flipVertical:".crop-flip-vertical"},guides:!1,center:!1,movable:!1,zoomable:!1,setDragMode:"crop",viewMode:1},messages:{cropLoadFail:"Could not load the image.",cropSaveFail:"Could not save the image."},cropsave:function cropsave(e,file){file.original&&this.trigger("renderdownload",e,{files:[file]}),this.plugins.crop.hide()},cropsavefail:function cropsavefail(e,jqXHR){alert(jqXHR.responseJSON||this.trans("cropSaveFail"))},cropsavealways:function cropsavealways(){this.plugins.crop.toggleSaveBtn(),this.plugins.crop.image.cropper("enable")},cropload:function cropload(e,image){var crop=this.plugins.crop;crop.options.loading&&crop.options.loading.hide(),crop.options._preview.html(image).show(),crop.image=image.cropper(crop.options),crop.options.saveBtn.prop("disabled",!1),this.trigger("cropper",e,[crop.image])},croploadfail:function croploadfail(){alert(this.trans("cropLoadFail"))}};function Crop(filepicker){filepicker.extend(this,defaults)}function addTimestamp(src){return src+(src.indexOf("?")>-1?"&":"?")+(new Date).getTime()}Crop.prototype.init=function(){this.options=this.$f.options.crop,this._initOptions(),this._initHandlers()},Crop.prototype._initOptions=function(){var o=this.options,s=this.options.selectors;if(o.container||(o.container=$(s.container)),!o.container)return!1;o.loading||(o.loading=o.container.find(s.loading)),o._preview||(o._preview=o.container.find(s.preview)),o.saveBtn||(o.saveBtn=o.container.find(s.save),o.saveBtn.prop("disabled",!0)),o.hideBtn||(o.hideBtn=o.container.find(s.hide)),o.rotateLeftBtn||(o.rotateLeftBtn=o.container.find(s.rotateLeft)),o.rotateRightBtn||(o.rotateRightBtn=o.container.find(s.rotateRight)),o.flipHorizontal||(o.flipHorizontal=o.container.find(s.flipHorizontal)),o.flipVertical||(o.flipVertical=o.container.find(s.flipVertical))},Crop.prototype._initHandlers=function(){var _this=this,o=this.options;this.on(o.showBtn,"click",this.show),this.on(o.saveBtn,"click",this.save),this.on(o.hideBtn,"click",this.hide),this.on(o.rotateLeftBtn,"click",(function(){return _this.rotate(-90)})),this.on(o.rotateRightBtn,"click",(function(){return _this.rotate(90)})),this.on(o.flipHorizontal,"click",(function(){if(_this.image){var scaleX=_this.image.cropper("getData").scaleX;_this.image.cropper("scaleX",1==scaleX?-1:1)}})),this.on(o.flipVertical,"click",(function(){if(_this.image){var scaleY=_this.image.cropper("getData").scaleY;_this.image.cropper("scaleY",1==scaleY?-1:1)}})),this.isModal()&&o.container.on("hidden.bs.modal",(function(){return _this.hide()})).on("shown.bs.modal",(function(e){_this.loadPreview(e.relatedTarget.fileurl?e.relatedTarget.fileurl:$(e.relatedTarget.currentTarget))})),this.$f.plugins.ui&&(this.on(this.$f.element,"click",o.selectors.crop,this.show),this.$f.on("renderdone",(function(e,data){$.each(data.files,(function(_,file){file.context.find(o.selectors.crop).data("fileurl",file.url)}))})))},Crop.prototype.show=function(e){if("object"===$.type(e))e.preventDefault();else{var url=e;(e=$.Event("click")).fileurl=url}this.isModal()?(this.options.container.appendTo("body"),this.options.container.modal("show",e)):(this.options.container.show(),this.loadPreview($(e.currentTarget)))},Crop.prototype.loadPreview=function(target){target instanceof $?(this.fileContext=$(target).closest(".download-template"),this.loadImage($(target).data("fileurl"))):this.loadImage(target)},Crop.prototype.loadImage=function(src){var _this2=this,image=$("<img>",{src:addTimestamp(src),class:"img-responsive"});image.on("load",(function(e){return _this2.trigger("cropload",e,image)})).on("error",(function(e){return _this2.trigger("croploadfail",e,image)}))},Crop.prototype.hide=function(e){null!=e&&(e.stopPropagation(),this.isModal()?$(this.options.container).modal("hide"):this.options.container.hide(),this.options._preview.html(""))},Crop.prototype.save=function(e){var _this3=this;this.toggleSaveBtn(),this.image.cropper("disable");var data=this.image.cropper("getData");this.$f.update(this.getFilename(),data).done((function(file,_,jqXHR){file.versions&&file.versions.thumb&&(file.versions.thumb.url=addTimestamp(file.versions.thumb.url)),_this3.fileContext&&(file.original={context:_this3.fileContext}),_this3.trigger("cropsave",e,[file,jqXHR])})).fail((function(jqXHR){return _this3.trigger("cropsavefail",e,jqXHR)})).always((function(datajqXHR){return _this3.trigger("cropsavealways",e,datajqXHR)}))},Crop.prototype.rotate=function(degree){if(!this.image)return!1;var image=this.image,contData=image.cropper("getContainerData");image.cropper("setCropBoxData",{width:2,height:2,top:contData.height/2-1,left:contData.width/2-1}),image.cropper("rotate",degree);var newCanvData=void 0,canvData=image.cropper("getCanvasData"),newWidth=canvData.width*(contData.height/canvData.height);if(newWidth>=contData.width){var newHeight=canvData.height*(contData.width/canvData.width);newCanvData={width:contData.width,height:newHeight,top:(contData.height-newHeight)/2,left:0}}else newCanvData={width:newWidth,height:contData.height,top:0,left:(contData.width-newWidth)/2};image.cropper("setCanvasData",newCanvData),newCanvData.top=newCanvData.top+.1*newCanvData.height,newCanvData.left=newCanvData.left+.1*newCanvData.width,newCanvData.height=.8*newCanvData.height,newCanvData.width=.8*newCanvData.width,image.cropper("setCropBoxData",newCanvData)},Crop.prototype.getFilename=function(){var file=this.image.attr("src");return file.indexOf("?file=")>-1&&(file=file.substr(file.indexOf("?file=")+6)),(file.indexOf("?")>-1||file.indexOf("&")>-1)&&(file=file.substr(0,file.length-14)),decodeURI(file)},Crop.prototype.toggleSaveBtn=function(){var btn=this.options.saveBtn;$.fn.button?btn.button().data("bs.button").isLoading?btn.button("reset"):btn.button("loading"):btn.prop("disabled",!btn.prop("disabled"))},Crop.prototype.isModal=function(){return this.options.container&&this.options.container.hasClass("modal")},Filepicker.plugin("crop",Crop)}));